import e from"@hw-agconnect/api";import{DEFAULT_CATEGORY as t,InstanceMap as r}from"@hw-agconnect/core";import{AGCError as n,BaseResponse as o,ConnectRet as i}from"@hw-agconnect/instance";import"@hw-agconnect/network";import"@hw-agconnect/storage";import"@hw-agconnect/util";import{Logger as s}from"@hw-agconnect/log";import"@hw-agconnect/baseservice";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function c(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))}function d(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var h,p=function(){function e(){}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.getStorage=function(e){var t=e.getService("AGCStorageService");if(null!=t){var r=Fe.get([e.name()]);return t.getStorageInstance(Number(r.getUserInfoPersistence()),r.getCryptImp()?r.getCryptImp():e.getCryptImp())}Pe.error("Get AGC storage Service failed.")},e}(),f=function(){function e(){this.providerInfo=new Array}return e.prototype.getProviderInfo=function(){return this.providerInfo},e.prototype.setProviderInfo=function(e){this.providerInfo=e},e.prototype.updateProvider=function(e){if(e&&this.providerInfo){var t=e.provider;t&&this.deleteProvider(t),this.providerInfo.push(e)}},e.prototype.updateProviderInfo=function(e,t,r){var n=this.findProviderIndex(e.toString());null!=n&&(this.providerInfo[n][t]=r)},e.prototype.updateEmail=function(e){this.updateProviderInfo(12,"email",e)},e.prototype.updatePhone=function(e){this.updateProviderInfo(11,"phone",e)},e.prototype.deleteProvider=function(e){var t=this.findProviderIndex(e);this.providerInfo&&null!=t&&this.providerInfo.splice(t,1)},e.prototype.findProviderIndex=function(e){var t=void 0;if(e&&this.providerInfo)for(var r=0;r<this.providerInfo.length;r++){var n=this.providerInfo[r];if(n&&e==n.provider){t=r;break}}return t},e}(),l=function(){function e(e,t,r,n){this.state=void 0,this.expiration=e,this.issuedAt=t,this.notBefore=r,this.tokenString=n}return e.prototype.getState=function(){return this.state},e.prototype.getToken=function(){return this.tokenString},e}(),g=function(e){function t(r,n){var o=e.call(this,r,n,"auth")||this;return o.__proto__=t.prototype,o}return u(t,e),t.constructExcpFromRet=function(e){return new t({code:e.getCode(),message:e.getMsg()})},t}(n),v=function(){function e(){}return e.NULL_TOKEN={code:1,message:"token is null"},e.NOT_SIGN_IN={code:2,message:"no user signed in"},e.USER_LINK_FAILED={code:3,message:"user link faild"},e.USER_UNLINK_FAILED={code:4,message:"user unlink faild"},e.ALREADY_SIGN_IN_USER={code:5,message:"already sign in a user"},e.EMAIL_VERIFICATION_IS_EMPTY={code:6,message:"email verification code is empty"},e.PHONE_VERIFICATION_IS_EMPTY={code:7,message:"phone verification code is empty"},e.ILLEGAL_TOKEN_LISTENER={code:8,message:"illegal token listener"},e.ILLEGAL_CUSTOM_AUTH_PROVIDER={code:9,message:"illegal custom auth provider"},e.FAIL_TO_GET_CREDENTIAL_SERVICE={code:10,message:"get agcCredential service failed"},e.FAIL_TO_GET_NETWORK_SERVICE={code:11,message:"get agcNetwork service failed"},e.FAIL_TO_GET_STORAGE_SERVICE={code:12,message:"get agcStorage service failed"},e.FAIL_TO_GET_USER_EXTRA={code:13,message:"get user extra fail"},e.FAIL_TO_GET_ACCESS_TOKEN={code:14,message:"get user access token fail"},e.FAIL_TO_DO_USER_REAUTH={code:15,message:"user reauthenticate fail"},e.FAIL_TO_UPDATE_PROFILE={code:16,message:"update user reauthenticate fail"},e.FAIL_TO_UPDATE_EMAIL={code:17,message:"update user email fail"},e.FAIL_TO_UPDATE_PHONE={code:18,message:"update user phone fail"},e.FAIL_TO_UPDATE_PASSWORD={code:19,message:"update user password fail"},e.PASSWORD_IS_EMPTY={code:20,message:"password is empty"},e.FAIL_TO_GET_VERIFY_CODE={code:21,message:"get verify code failed"},e.FAIL_TO_CREAT_EMAIL_USER={code:22,message:"create email user failed"},e.FAIL_TO_CREAT_PHONE_USER={code:23,message:"create phone user failed"},e.SIGN_IN_FAILED={code:24,message:"sign in failed"},e.DELETE_USER_FAILED={code:25,message:"delete user failed"},e.SIGN_OUT_FAILED={code:26,message:"sign out failed"},e.GET_CURRENT_USER_FAILED={code:27,message:"get current user failed"},e.SIGN_IN_ANONYMOUS_FAILED={code:28,message:"sign in anonymously failed"},e.FAIL_TO_GET_UTIL_SERVICE={code:29,message:"get clientInfoUtil service failed"},e.FAIL_TO_RESET_PASSWORD_EMAIL={code:30,message:"reset password by email failed"},e.FAIL_TO_RESET_PASSWORD_PHONE={code:31,message:"reset password by phone failed"},e.AUTH_INNER_ERROR={code:32,message:"agc auth service inner error"},e.INVALID_EMAIL={code:203817223,message:"invalid email"},e.INVALID_PHONE={code:203817224,message:"invalid phone"},e}(),y=function(){function t(){this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerProductId="",this.headerAppId="",this.headerClientId="",this.agcgwUrl="",this.agcgwBackUrl="",this.agcConfig=null,this.instance=null,this.sdkServiceName="agconnect-auth",this.sdkVersion="1.5.1",this.accessToken="",this.authorization="",this.headerAaId="",this.setAGCInstance(e.instance())}return t.prototype.setAGCInstance=function(e){if(!e)throw new g(v.AUTH_INNER_ERROR,{message:"set AGCInstance using null or undefined object"});this.instance=e,this.agcConfig=null},t.prototype.getHeaderProductId=function(){return this.initConfig()?this.headerProductId:""},t.prototype.setAccessToken=function(e){this.accessToken=e},t.prototype.getAgcgwUrl=function(){return this.initConfig()?this.agcgwUrl:""},t.prototype.getAuthHeader=function(){if(!this.initConfig())return"";var e=this.instance.getService("AGCPlatformInfoService");return e&&(this.sdkPlatform=e.getPlatform(),this.sdkPlatformVersion=e.getPlatformVersion(),this.packageName=e.getPackageName(),this.appVersion=e.getAppVersion()),{sdkVersion:this.sdkVersion,sdkPlatform:this.sdkPlatform,sdkPlatformVersion:this.sdkPlatformVersion,sdkType:this.sdkType,packageName:this.packageName,appVersion:this.appVersion,sdkServiceName:this.sdkServiceName,app_id:this.headerAppId,client_id:this.headerClientId,productId:this.headerProductId,access_token:this.accessToken,Authorization:this.authorization,"Content-Type":"application/json;charset=UTF-8"}},t.prototype.initConfig=function(){if(!this.instance)throw new g(v.AUTH_INNER_ERROR,{message:"set AGCInstance using null or undefined object"});return null==this.agcConfig&&(this.agcConfig=this.instance.config(),this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.agcgwUrl=this.instance.getGwUrl(),this.agcgwBackUrl=this.instance.getGwBackUrl()),!0},t}(),m=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t.SERVER_URL="/agc/apigw/oauth2/third/v1",t}(y),P=function(e){function t(t,r){var n=e.call(this)||this;return n.URL=m.SERVER_URL+"/user-auth/refresh-token",n.useJwt=0,n.refreshToken=t,n.useJwt=r,n}return u(t,e),t.prototype.getBody=function(){return{refreshToken:this.refreshToken,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),w=function(){function e(){this.token="",this.validPeriod=0}return e.prototype.getToken=function(){return this.token},e.prototype.setToken=function(e){this.token=e},e.prototype.getValidPeriod=function(){return this.validPeriod},e.prototype.setValidPeriod=function(e){this.validPeriod=e},e}(),I=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.accessToken=new w,t.productId="",t.uid="",t}return u(t,e),t.prototype.constructResponse=function(e){this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.productId=e.data.productId,this.uid=e.data.uid,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t}(o),T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-profile",t}return u(t,e),t.prototype.getBody=function(){},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(y),E=function(e){function t(){var t=e.call(this)||this;return t.displayName="",t.photoUrl="",t.emailVerified=0,t.passwordSetted=0,t.email="",t.phone="",t.userExtra=null,t}return u(t,e),t.prototype.constructResponse=function(e){this.displayName=e.data.displayName,this.photoUrl=e.data.photoUrl,this.emailVerified=e.data.emailVerified,this.passwordSetted=e.data.passwordSetted,this.email=e.data.email,this.phone=e.data.phone,this.userExtra=new U,this.userExtra.createTime=e.data.userMetaData.createTime,this.userExtra.lastSignInTime=e.data.userMetaData.lastSignInTime,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t}(o),U=function(){function e(){this.createTime="",this.lastSignInTime=""}return e.prototype.getCreateTime=function(){return this.createTime},e.prototype.getLastSignInTime=function(){return this.lastSignInTime},e}(),_=function(){function e(e,t){this.token=e,this.expirePeriod=t}return e.prototype.getToken=function(){return this.token},e.prototype.getExpirePeriod=function(){return this.expirePeriod},e}(),k=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-link",t.provider=-1,t.token="",t.extraData="",t.useJwt=0,t}return u(t,e),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getExtraData=function(){return this.extraData},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,useJwt:this.useJwt}},t}(m),R=function(){function e(){this.autoCreateUser=!0}return e.prototype.getProvider=function(){return-1},e}(),A=function(){function e(){this.password=void 0,this.verifyCode=void 0}return e.prototype.getProvider=function(){return-1},e}(),S=function(e){function t(){var t=e.call(this)||this;return t.providerUserInfo=void 0,t}return u(t,e),t.prototype.getProviderUserInfo=function(){return this.providerUserInfo},t.prototype.setProviderUserInfo=function(e){this.providerUserInfo=e},t.prototype.constructResponse=function(e){this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code),e.data.providerUserInfo&&this.setProviderUserInfo(e.data.providerUserInfo)},t}(o),C=function(){function e(e){this.user=e}return e.prototype.getUser=function(){return this.user},e}(),L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-unlink",t.provider=-1,t}return u(t,e),t.prototype.getProvider=function(){return this.provider},t.prototype.setProvider=function(e){this.provider=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()+"&provider="+this.getProvider()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{}},t}(m),N=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),O=function(e){function t(t,r,n){var o=e.call(this)||this;return o.playerSign=t,o.extraData=r,o.autoCreateUser=n,o}return u(t,e),t.prototype.getProvider=function(){return 5},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(5),e.setToken(this.playerSign),e.setExtraData(this.extraData),e.setUseJwt(1)},t}(R),D=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-reauthenticate",t.provider=-1,t.token="",t.extraData="",t.autoCreateUser=0,t.useJwt=1,t}return u(t,e),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.setAutoCreateUser=function(e){this.autoCreateUser=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,autoCreateUser:this.autoCreateUser,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),V=function(){function e(){this.uid="",this.displayName="",this.photoUrl="",this.phone="",this.email="",this.provider=-1,this.openId="",this.emailVerified=0,this.passwordSetted=0}return e.prototype.getUid=function(){return this.uid},e.prototype.setUid=function(e){this.uid=e},e.prototype.getDisplayName=function(){return this.displayName},e.prototype.setDisplayName=function(e){this.displayName=e},e.prototype.getPhotoUrl=function(){return this.photoUrl},e.prototype.setPhotoUrl=function(e){this.photoUrl=e},e.prototype.getPhone=function(){return this.phone},e.prototype.setPhone=function(e){this.phone=e},e.prototype.getEmail=function(){return this.email},e.prototype.setEmail=function(e){this.email=e},e.prototype.getProvider=function(){return this.provider},e.prototype.setProvider=function(e){this.provider=e},e.prototype.getOpenId=function(){return this.openId},e.prototype.setOpenId=function(e){this.openId=e},e.prototype.getEmailVerified=function(){return this.emailVerified},e.prototype.setEmailVerified=function(e){this.emailVerified=e},e.prototype.getPasswordSetted=function(){return this.passwordSetted},e.prototype.setPasswordSetted=function(e){this.passwordSetted=e},e}(),b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.accessToken=new w,t.refreshToken=new w,t.userInfo=new V,t.providers=[],t}return u(t,e),t.prototype.constructResponse=function(e){this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.refreshToken.setToken(e.data.refreshToken.token),this.refreshToken.setValidPeriod(e.data.refreshToken.validPeriod),this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code),this.userInfo.setUid(e.data.userInfo.uid),this.userInfo.setEmail(e.data.userInfo.email),this.userInfo.setPhone(e.data.userInfo.phone),this.userInfo.setProvider(e.data.userInfo.provider),this.userInfo.setEmailVerified(e.data.userInfo.emailVerified),this.userInfo.setPasswordSetted(e.data.userInfo.passwordSetted),this.userInfo.setDisplayName(e.data.userInfo.displayName),this.userInfo.setOpenId(e.data.userInfo.openId),this.userInfo.setPhotoUrl(e.data.userInfo.photoUrl);for(var t=new Array,r=0;r<e.data.providers.length;r++){var n={};this.userInfoToMap(e.data.providers[r],n),t.push(n)}this.providers=t},t.prototype.getAccessToken=function(){return this.accessToken},t.prototype.setAccessToken=function(e){this.accessToken=e},t.prototype.getRefreshToken=function(){return this.refreshToken},t.prototype.setRefreshToken=function(e){this.refreshToken=e},t.prototype.getUserInfo=function(){return this.userInfo},t.prototype.getProviders=function(){return this.providers},t.prototype.userInfoToMap=function(e,t){e.uid&&(t.uid=e.uid.toString()),e.displayName&&(t.displayName=e.displayName.toString()),e.photoUrl&&(t.photoUrl=e.photoUrl.toString()),e.email&&(t.email=e.email.toString()),e.phone&&(t.phone=e.phone.toString()),e.provider&&(t.provider=e.provider.toString()),e.openId&&(t.openId=e.openId.toString())},t}(o),x=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(b),j=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-profile",t.displayName="",t.photoUrl="",t}return u(t,e),t.prototype.setDisplayName=function(e){this.displayName=e},t.prototype.setPhotoUrl=function(e){this.photoUrl=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{displayName:this.displayName,photoUrl:this.photoUrl}},t}(m),F=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),G=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-phone-email",t.newEmail="",t.newVerifyCode="",t.lang="",t}return u(t,e),t.prototype.setNewVerifyCode=function(e){this.newVerifyCode=e},t.prototype.setNewEmail=function(e){this.newEmail=e},t.prototype.setLang=function(e){this.lang=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{lang:this.lang,newEmail:this.newEmail,newVerifyCode:this.newVerifyCode}},t}(m),H=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),M=function(){function e(){}return e.combinatePhone=function(e,t){return null==e||e.startsWith("+")||(e="+"+e),e+"-"+t},e}(),q=function(e){function t(t,r,n,o){var i=e.call(this)||this;return i.URL=m.SERVER_URL+"/user-phone-email",i.countryCode=t,i.newPhone=r,i.newVerifyCode=n,i.lang=o,i}return u(t,e),t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{lang:this.lang,newPhone:M.combinatePhone(this.countryCode,this.newPhone),newVerifyCode:this.newVerifyCode}},t}(m),B=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),J=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-password",t.verifyCode="",t.newPassword="",t.provider=0,t}return u(t,e),t.prototype.getProvider=function(){return this.provider},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setNewPassword=function(e){this.newPassword=e},t.prototype.setNewverifyCode=function(e){this.verifyCode=e},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getBody=function(){return{provider:this.provider,verifyCode:this.verifyCode,newPassword:this.newPassword}},t}(m),W=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),K=function(){function t(t){this.instance=t||e.instance(),this.authBackend=new Z(this.instance),this.storedUserManager=new re(this.instance),this.user=new ee(this.instance.name())}return t.prototype.getUser=function(){return this.user},t.prototype.isAnonymous=function(){return this.user.anonymous},t.prototype.getUid=function(){return this.user.uid},t.prototype.getEmail=function(){return this.user.email},t.prototype.getPhone=function(){return this.user.phone},t.prototype.getDisplayName=function(){return this.user.displayName},t.prototype.getPhotoUrl=function(){return this.user.photoUrl},t.prototype.getProviderId=function(){return this.user.providerId},t.prototype.getProviderInfo=function(){for(var e=new Array,t=0;t<this.user.providerService.getProviderInfo().length;t++){for(var r=new Map,n=Object.keys(this.user.providerService.getProviderInfo()[t]),o=0;n&&o<n.length;o++)r.set(n[o],this.user.providerService.getProviderInfo()[t][n[o]]);e.push(r)}return e},t.prototype.getUserExtra=function(){return c(this,void 0,void 0,(function(){var e,t,r,o=this;return d(this,(function(i){switch(i.label){case 0:return e=null,t="",r=this,[4,this.storedUserManager.getStoredUser().then((function(n){return c(o,void 0,void 0,(function(){var o,i;return d(this,(function(s){switch(s.label){case 0:return n?""==(t=n.tokenService.accessToken)?[3,3]:(o=new T,i=new E,o.setAccessToken(t),o.setAGCInstance(r.instance),[4,r.authBackend.get(o,i)]):[3,3];case 1:return s.sent(),0!=i.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(i.getRet()))]:(r.user.displayName=i.displayName,r.user.photoUrl=i.photoUrl,r.user.emailVerified=i.emailVerified,r.user.passwordSetted=i.passwordSetted,r.user.email=i.email,r.user.phone=i.phone,r.user.displayName=i.displayName,e=i.userExtra,[4,r.storedUserManager.updateStoredUser(r)]);case 2:return s.sent(),[2,Promise.resolve()];case 3:return[2]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_GET_USER_EXTRA,e))}))];case 1:return i.sent(),[2,Promise.resolve(e)]}}))}))},t.prototype.getAccessToken=function(){return this.user.tokenService.getAccessToken()},t.prototype.getRefreshToken=function(){return this.user.tokenService.getRefreshToken()},t.prototype.buildUser=function(e){this.user.anonymous=!1,this.user.uid=e.getUserInfo().getUid(),this.user.displayName=e.getUserInfo().getDisplayName(),this.user.photoUrl=e.getUserInfo().getPhotoUrl(),this.user.email=e.getUserInfo().getEmail(),this.user.emailVerified=e.getUserInfo().getEmailVerified(),this.user.passwordSetted=e.getUserInfo().getPasswordSetted(),this.user.phone=e.getUserInfo().getPhone(),this.user.providerId=e.getUserInfo().getProvider().toString(),this.user.tokenService.constructeSecureTokenService(e.getAccessToken(),e.getRefreshToken()),this.user.providerService.setProviderInfo(e.getProviders())},t.prototype.getToken=function(e){return this.user.tokenService.fetchAccessToken(e).then((function(e){return Promise.resolve(new _(e.tokenString,e.expiration))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_GET_ACCESS_TOKEN,e))}))},t.prototype.getEmailVerified=function(){return this.user.emailVerified},t.prototype.getPasswordSetted=function(){return this.user.passwordSetted},t.prototype.link=function(e){return c(this,void 0,void 0,(function(){var t,r,o,i=this;return d(this,(function(s){switch(s.label){case 0:if(!e)return[2,Promise.reject(new g(v.USER_LINK_FAILED,{message:"credential cannot be null or undefined"}))];if(t=new k,e instanceof R)e.prepareUserLinkRequest(t);else{if(!(e instanceof A))return[2,Promise.reject(new g(v.USER_LINK_FAILED,{message:"credential type error"}))];e.prepareUserLinkRequest(t)}return e instanceof O&&((r=JSON.parse(t.getExtraData())).appId=this.instance.config().client.app_id,r.cpId=this.instance.config().client.cp_id,t.setExtraData(JSON.stringify(r))),o=this,[4,this.getToken(!1).then((function(r){return c(i,void 0,void 0,(function(){var n,i,s,a,u,c;return d(this,(function(d){switch(d.label){case 0:return t.setAccessToken(r.getToken()),t.setAGCInstance(o.instance),n=new S,[4,o.authBackend.post(t,n)];case 1:return d.sent(),0!=n.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(n.getRet()))]:((i=n.getProviderUserInfo())&&(s={},o.userInfoToMap(i,s),o.user.anonymous&&o.updateAnonymousUserInfo(s),o.user.providerService.updateProvider(s),s.provider&&(a=s.provider,12..toString()==a?(u=s.email)&&(o.user.email=u,o.user.emailVerified=1):11..toString()==a&&(c=s.phone)&&(o.user.phone=c),e instanceof A&&null!=e.password&&null!=e.password&&""!=e.password&&(o.user.passwordSetted=1))),[4,o.storedUserManager.updateStoredUser(o)]);case 2:return d.sent(),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.USER_LINK_FAILED,e))}))];case 1:return s.sent(),[2,Promise.resolve(new C(this))]}}))}))},t.prototype.unlink=function(e){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){switch(r.label){case 0:return e?this.user.anonymous?[2,Promise.reject(new g(v.USER_UNLINK_FAILED,{message:"anonymous user can not unlink"}))]:[4,this.sendUnlinkRequest(e).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.USER_UNLINK_FAILED,e))}))]:[2,Promise.reject(new g(v.USER_UNLINK_FAILED,{message:"credentialProvider cannot be null or undefined"}))];case 1:return t=r.sent(),[2,Promise.resolve(t)]}}))}))},t.prototype.userInfoToMap=function(e,t){e.uid&&(t.uid=e.uid.toString()),e.displayName&&(t.displayName=e.displayName.toString()),e.photoUrl&&(t.photoUrl=e.photoUrl.toString()),e.email&&(t.email=e.email.toString()),e.phone&&(t.phone=e.phone.toString()),e.provider&&(t.provider=e.provider.toString()),e.openId&&(t.openId=e.openId.toString())},t.prototype.updateAnonymousUserInfo=function(e){this.user.anonymous=!1,this.user.displayName=e.displayName?e.displayName:"",this.user.photoUrl=e.photoUrl?e.photoUrl:"",this.user.email=e.email?e.email:"",this.user.phone=e.phone?e.phone:"",this.user.providerId=e.provider?e.provider:""},t.prototype.sendUnlinkRequest=function(e){return c(this,void 0,void 0,(function(){var t,r,n;return d(this,(function(o){switch(o.label){case 0:return(t=new L).setProvider(e),[4,this.getToken(!1)];case 1:return r=o.sent(),t.setAccessToken(r.getToken()),t.setAGCInstance(this.instance),n=new N,[4,this.authBackend.post(t,n)];case 2:return o.sent(),0==n.getRet().getCode()?[3,3]:[2,Promise.reject(g.constructExcpFromRet(n.getRet()))];case 3:return this.user.providerService.deleteProvider(e.toString()),12==e&&(this.user.email="",this.user.emailVerified=0),11==e&&(this.user.phone=""),null==this.user.providerService.findProviderIndex(12..toString())&&null==this.user.providerService.findProviderIndex(11..toString())&&(this.user.passwordSetted=0),[4,this.storedUserManager.updateStoredUser(this)];case 4:return o.sent(),[2,Promise.resolve(new C(this))]}}))}))},t.prototype.userReauthenticate=function(e){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){switch(r.label){case 0:return e?[4,this.getUserReauthWithCredential(e).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_DO_USER_REAUTH,e))}))]:[2,Promise.reject(new g(v.FAIL_TO_DO_USER_REAUTH,{message:"credential invalid"}))];case 1:return t=r.sent(),[2,Promise.resolve(t)]}}))}))},t.prototype.getUserReauthWithCredential=function(e){return c(this,void 0,void 0,(function(){var t,r,n;return d(this,(function(o){switch(o.label){case 0:return t=new D,[4,this.getToken(!1)];case 1:return r=o.sent(),t.setAccessToken(r.getToken()),e instanceof R||e instanceof A?(e.prepareUserReauthRequest(t),t.setAGCInstance(this.instance),n=new x,[4,this.authBackend.post(t,n)]):[2,Promise.reject(new g(v.FAIL_TO_DO_USER_REAUTH,{message:"credential type error"}))];case 2:return o.sent(),0!=n.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(n.getRet()))]:(this.buildUser(n),[4,this.storedUserManager.updateStoredUser(this,1)]);case 3:return o.sent(),[2,Promise.resolve(new C(this))]}}))}))},t.prototype.updateProfile=function(e){return c(this,void 0,void 0,(function(){var t,r,o=this;return d(this,(function(i){switch(i.label){case 0:return null==e.displayName||null==e.displayName||null==e.photoUrl||null==e.photoUrl?[3,2]:(t=new j,r=this,[4,this.getToken(!1).then((function(n){return c(o,void 0,void 0,(function(){var o;return d(this,(function(i){switch(i.label){case 0:return t.setAccessToken(n.getToken()),t.setDisplayName(e.displayName),t.setPhotoUrl(e.photoUrl),t.setAGCInstance(r.instance),o=new F,[4,r.authBackend.put(t,o)];case 1:return i.sent(),0!=o.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(o.getRet()))]:(Pe.log("updateProfile success."),r.user.displayName=e.displayName,r.user.photoUrl=e.photoUrl,[4,r.storedUserManager.updateStoredUser(r)]);case 2:return i.sent(),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_UPDATE_PROFILE,e))}))]);case 1:return i.sent(),[3,3];case 2:return[2,Promise.reject(new g(v.FAIL_TO_UPDATE_PROFILE,{message:"displayName or photoUrl can not be null"}))];case 3:return[2,Promise.resolve()]}}))}))},t.prototype.updateEmail=function(e,t,r){return c(this,void 0,void 0,(function(){var o,i,s=this;return d(this,(function(a){switch(a.label){case 0:return e?t?((o=new G).setNewEmail(e),o.setNewVerifyCode(t),o.setLang(r),i=this,[4,this.getToken(!1).then((function(t){return c(s,void 0,void 0,(function(){var r;return d(this,(function(n){switch(n.label){case 0:return o.setAccessToken(t.getToken()),o.setAGCInstance(i.instance),r=new H,[4,i.authBackend.put(o,r)];case 1:return n.sent(),0!=r.getRet().getCode()?(Pe.error("updateEmail fail."),[2,Promise.reject(g.constructExcpFromRet(r.getRet()))]):(Pe.log("updateEmail success."),i.user.email=e,i.user.providerService.updateEmail(e),[4,i.storedUserManager.updateStoredUser(i)]);case 2:return n.sent(),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_UPDATE_EMAIL,e))}))]):[2,Promise.reject(new g(v.FAIL_TO_UPDATE_EMAIL,{message:"verifyCode cannot be null or undefined"}))]:[2,Promise.reject(new g(v.FAIL_TO_UPDATE_EMAIL,{message:"newEmail cannot be null or undefined"}))];case 1:return a.sent(),[2]}}))}))},t.prototype.updatePhone=function(e,t,r,o){return c(this,void 0,void 0,(function(){var i,s=this;return d(this,(function(a){switch(a.label){case 0:return t?r?(i=this,[4,this.getToken(!1).then((function(n){return c(s,void 0,void 0,(function(){var s,a,u;return d(this,(function(c){switch(c.label){case 0:return[4,(s=new q(e,t,r,o)).setAccessToken(n.getToken())];case 1:return c.sent(),s.setAGCInstance(i.instance),a=new B,[4,i.authBackend.put(s,a)];case 2:return c.sent(),0!=a.getRet().getCode()?(Pe.error("updatePhone fail."),[2,Promise.reject(g.constructExcpFromRet(a.getRet()))]):(Pe.log("updatePhone success."),u=M.combinatePhone(e,t),i.user.phone=u,i.user.providerService.updatePhone(u),[4,i.storedUserManager.updateStoredUser(i)]);case 3:return c.sent(),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_UPDATE_PHONE,e))}))]):[2,Promise.reject(new g(v.FAIL_TO_UPDATE_PHONE,{message:"verifyCode cannot be null or undefined"}))]:[2,Promise.reject(new g(v.FAIL_TO_UPDATE_PHONE,{message:"newPhone cannot be null or undefined"}))];case 1:return a.sent(),[2]}}))}))},t.prototype.updatePassword=function(e,t,r){return c(this,void 0,void 0,(function(){var o,i=this;return d(this,(function(s){switch(s.label){case 0:return e?(o=this,[4,this.getToken(!1).then((function(n){return c(i,void 0,void 0,(function(){var i,s;return d(this,(function(a){switch(a.label){case 0:return(i=new J).setProvider(r),i.setNewPassword(e),i.setNewverifyCode(t),i.setAccessToken(n.getToken()),i.setAGCInstance(o.instance),s=new W,[4,o.authBackend.put(i,s)];case 1:return a.sent(),0!=s.getRet().getCode()?(Pe.error("updatePassword fail."),[2,Promise.reject(g.constructExcpFromRet(s.getRet()))]):0!=o.user.passwordSetted?[3,3]:(o.user.passwordSetted=1,[4,o.storedUserManager.updateStoredUser(o)]);case 2:a.sent(),a.label=3;case 3:return Pe.log("updatePassword success."),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_UPDATE_PASSWORD,e))}))]):[2,Promise.reject(new g(v.FAIL_TO_UPDATE_PASSWORD,{message:"newPassword cannot be null or undefined"}))];case 1:return s.sent(),[2]}}))}))},t}();!function(e){e[e.POST=0]="POST",e[e.GET=1]="GET",e[e.PUT=2]="PUT"}(h||(h={}));var Y,X,z,Q,Z=function(){function t(t){this.instance=t||e.instance(),this.storedUserManager=new re(this.instance)}return t.prototype.getClientToken=function(e){return c(this,void 0,void 0,(function(){var t,r;return d(this,(function(n){switch(n.label){case 0:return(t=this.instance.getService("CredentialsService"))?(r="",[4,t.getToken(e).then((function(e){r=e.tokenString}))]):[2,Promise.reject(new g(v.FAIL_TO_GET_CREDENTIAL_SERVICE))];case 1:return n.sent(),[2,Promise.resolve(r)]}}))}))},t.prototype.post=function(e,t){return c(this,void 0,void 0,(function(){var r,n,o;return d(this,(function(i){switch(i.label){case 0:return r=e.getHeader(),n=r,o="Bearer ",[4,this.getClientToken()];case 1:return n.Authorization=o+i.sent(),[2,this.sendRequest(e,h.POST,t,r,!0,!0)]}}))}))},t.prototype.get=function(e,t){return c(this,void 0,void 0,(function(){var r,n,o;return d(this,(function(i){switch(i.label){case 0:return r=e.getHeader(),n=r,o="Bearer ",[4,this.getClientToken()];case 1:return n.Authorization=o+i.sent(),[2,this.sendRequest(e,h.GET,t,r,!0,!0)]}}))}))},t.prototype.put=function(e,t){return c(this,void 0,void 0,(function(){var r,n,o;return d(this,(function(i){switch(i.label){case 0:return r=e.getHeader(),n=r,o="Bearer ",[4,this.getClientToken()];case 1:return n.Authorization=o+i.sent(),[2,this.sendRequest(e,h.PUT,t,r,!0,!0)]}}))}))},t.prototype.sendRequest=function(e,r,o,s,a,u){return c(this,void 0,void 0,(function(){var h=this;return d(this,(function(p){switch(p.label){case 0:return[4,this.doNetworkOption(r,e,s,o).catch((function(p){return c(h,void 0,void 0,(function(){var c,h,f,l,y;return d(this,(function(d){switch(d.label){case 0:return p instanceof n?[2,Promise.reject(p)]:this.checkIsTokenError(p)?(c=p.response.data.ret.code)==t.CLIENT_TOKEN_EXPIRED&&a?(h=this.instance.getService("CredentialsService"))?[4,h.removeToken()]:[2,Promise.reject(new g(v.FAIL_TO_GET_CREDENTIAL_SERVICE))]:[3,3]:[3,8];case 1:return d.sent(),f=s,l="Bearer ",[4,this.getClientToken(!0)];case 2:return f.Authorization=l+d.sent(),o.setRet(new i),[2,this.sendRequest(e,r,o,s,!1,u)];case 3:return c==t.ACCESS_TOKEN_EXPIRED&&u?(y=new K(this.instance),[4,this.storedUserManager.getStoredUser().then((function(e){return null==e?Promise.reject(new g(v.NOT_SIGN_IN)):(y.getUser().constructUser(e),Promise.resolve())}))]):[3,6];case 4:return d.sent(),[4,y.getToken(!0).then((function(e){s.access_token=e.getToken()}))];case 5:return d.sent(),o.setRet(new i),[2,this.sendRequest(e,r,o,s,a,!1)];case 6:return[2,Promise.reject(p)];case 7:return[3,9];case 8:return[2,Promise.reject(p)];case 9:return[2]}}))}))}))];case 1:return[2,p.sent()]}}))}))},t.prototype.doNetworkOption=function(e,t,r,n){return c(this,void 0,void 0,(function(){var o;return d(this,(function(s){switch(s.label){case 0:return(o=this.instance.getService("AGCNetworkService"))?e!=h.POST?[3,2]:[4,o.post(t.getUrl(),t.getBody(),r).then((function(e){0==e.data.ret.code&&n.constructResponse(e),n.setRet(new i(e.data.ret.code,e.data.ret.msg))})).catch((function(e){return Promise.reject(e)}))]:[2,Promise.reject(new g(v.FAIL_TO_GET_NETWORK_SERVICE))];case 1:return s.sent(),[3,6];case 2:return e!=h.PUT?[3,4]:[4,o.put(t.getUrl(),t.getBody(),r).then((function(e){0==e.data.ret.code&&n.constructResponse(e),n.setRet(new i(e.data.ret.code,e.data.ret.msg))})).catch((function(e){return Promise.reject(e)}))];case 3:return s.sent(),[3,6];case 4:return[4,o.get(t.getUrl(),t.getBody(),r).then((function(e){0==e.data.ret.code&&n.constructResponse(e),n.setRet(new i(e.data.ret.code,e.data.ret.msg))})).catch((function(e){return Promise.reject(e)}))];case 5:s.sent(),s.label=6;case 6:return[2,Promise.resolve()]}}))}))},t.prototype.checkIsTokenError=function(e){return!!(e.response&&401===e.response.status&&e.response.data&&e.response.data.ret&&null!=e.response.data.ret.code)},t.CLIENT_TOKEN_EXPIRED=205524993,t.ACCESS_TOKEN_EXPIRED=205524994,t}(),$=function(){function r(){this.TIME_EARLY=3e5,this.accessToken="",this.accessTokenValidPeriod=-1,this.refreshToken="",this.validTime=-1,this.instanceName=t}return r.prototype.constructeSecureTokenService=function(e,t){this.accessToken=e.getToken(),this.accessTokenValidPeriod=e.getValidPeriod(),this.refreshToken=t.getToken(),this.validTime=(new Date).getTime()+1e3*e.getValidPeriod()},r.prototype.getAccessToken=function(){return this.accessToken},r.prototype.getRefreshToken=function(){return this.refreshToken},r.prototype.isValidAccessToken=function(){return null!=this.accessToken&&this.remainToRefreshTime()>0},r.prototype.remainToRefreshTime=function(){return this.validTime-(new Date).getTime()-this.TIME_EARLY},r.prototype.fetchAccessToken=function(t){return c(this,void 0,void 0,(function(){var r,n,o,i,s=this;return d(this,(function(a){switch(a.label){case 0:return!t&&this.isValidAccessToken()?[2,Promise.resolve(new l(this.accessTokenValidPeriod,"0","0",this.accessToken))]:this.accessToken&&this.refreshToken?((r=new P(this.refreshToken,1)).setAGCInstance(e.instance(this.instanceName)),n=new I,[4,new Z(e.instance(this.instanceName)).post(r,n)]):[2,Promise.reject(new g(v.NULL_TOKEN))];case 1:return a.sent(),0!=n.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(n.getRet()))]:!(o=n.accessToken)||o.getToken()==this.accessToken&&o.getValidPeriod()==this.accessTokenValidPeriod?[3,3]:(this.accessToken=o.getToken(),this.accessTokenValidPeriod=o.getValidPeriod(),this.validTime=(new Date).getTime()+1e3*this.accessTokenValidPeriod,[4,(i=new re(e.instance(this.instanceName))).getStoredUser().then((function(e){return c(s,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return e&&(e.tokenService.accessToken=this.accessToken,e.tokenService.accessTokenValidPeriod=this.accessTokenValidPeriod,e.tokenService.refreshToken=this.refreshToken,e.tokenService.validTime=this.validTime),[4,i.updateUserInfo(e)];case 1:return t.sent(),[2]}}))}))}))]);case 2:a.sent(),a.label=3;case 3:return[2,Promise.resolve(new l(this.accessTokenValidPeriod,"0","0",this.accessToken))]}}))}))},r}(),ee=function(){function e(e){this.anonymous=!1,this.uid="",this.displayName="",this.photoUrl="",this.email="",this.phone="",this.providerId="",this.emailVerified=0,this.passwordSetted=0,this.providerService=new f,this.tokenService=new $,this.tokenService.instanceName=e}return e.prototype.constructUser=function(e){this.anonymous=e.anonymous,this.uid=e.uid,this.displayName=e.displayName,this.photoUrl=e.photoUrl,this.email=e.email,this.phone=e.phone,this.providerId=e.providerId,this.emailVerified=e.emailVerified,this.passwordSetted=e.passwordSetted,this.providerService.setProviderInfo(e.providerService.providerInfo),this.tokenService.accessToken=e.tokenService.accessToken,this.tokenService.accessTokenValidPeriod=e.tokenService.accessTokenValidPeriod,this.tokenService.refreshToken=e.tokenService.refreshToken,this.tokenService.validTime=e.tokenService.validTime},e}(),te=function(){function e(){this.lastNotifiedToken="DEFAULT",this.tokenListeners=new Array}return e.prototype.ListenerManager=function(){},e.getInstance=function(t){return this.instanceMap.has(t)||this.instanceMap.set(t,new e),this.instanceMap.get(t)},e.prototype.removeTokenListener=function(e){if(e)for(var t=0;t<this.tokenListeners.length;t++)if(this.tokenListeners[t]===e)return void this.tokenListeners.splice(t,1)},e.prototype.addTokenListener=function(e){if(!e)throw new g(v.ILLEGAL_TOKEN_LISTENER,{message:"listener cannot be null"});if(!(e.onChanged&&e.onChanged instanceof Function))throw new g(v.ILLEGAL_TOKEN_LISTENER,{message:"listener must have onChanged method"});this.tokenListeners.push(e)},e.prototype.postNotification=function(e,t){if(!(null!=t&&t==this.lastNotifiedToken||null==t&&null==this.lastNotifiedToken)){this.lastNotifiedToken=t;var r=new l(0,"0","0",t);r.state=e,this.tokenListeners.forEach((function(e){e.onChanged(r)}))}},e.instanceMap=new Map,e}(),re=function(){function t(t){this.user=null,this.agcConfig=null,this.instance=t||e.instance()}return t.prototype.getStoredUser=function(){return c(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.loadStoredUser()];case 1:return e.sent(),[2,Promise.resolve(this.user)]}}))}))},t.prototype.updateUserInfo=function(e){return c(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return e?(this.user||(this.user=new ee(this.instance.name())),this.user.constructUser(e)):this.user=null,[4,this.saveCurrentUser()];case 1:return t.sent(),[2]}}))}))},t.prototype.updateStoredUser=function(e,t){return c(this,void 0,void 0,(function(){var r;return d(this,(function(n){switch(n.label){case 0:return[4,this.updateUserInfo(e?e.getUser():null)];case 1:return n.sent(),null!=t&&null!=t&&(r=null!=e?e.getAccessToken():null,te.getInstance(this.instance.name()).postNotification(t,r)),[2]}}))}))},t.prototype.loadStoredUser=function(){return c(this,void 0,void 0,(function(){var e,t=this;return d(this,(function(r){switch(r.label){case 0:return null==(e=p.getInstance().getStorage(this.instance))?[2,Promise.reject(new g(v.FAIL_TO_GET_STORAGE_SERVICE))]:[4,e.get(this.getUserKey()).then((function(e){null!=e&&null!=e&&""!=e?(null==t.user&&(t.user=new ee(t.instance.name())),t.user.constructUser(JSON.parse(e))):t.user=null}))];case 1:return r.sent(),[2,Promise.resolve()]}}))}))},t.prototype.saveCurrentUser=function(){return c(this,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return null==(e=p.getInstance().getStorage(this.instance))?[2,Promise.reject(new g(v.FAIL_TO_GET_STORAGE_SERVICE))]:null!=this.user?[3,2]:[4,e.remove(this.getUserKey())];case 1:return t.sent(),[3,4];case 2:return[4,e.set(this.getUserKey(),JSON.stringify(this.user))];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))},t.prototype.getUserKey=function(){return null==this.agcConfig&&(this.agcConfig=this.instance.config()),"agcCurrentUser_"+this.instance.name()+":"+this.agcConfig.client.client_id},t}(),ne=function(e){function t(t,r,n,o){var i=e.call(this)||this;return i.URL=m.SERVER_URL+"/user-signin-anonymous",i.useJwt=0,i.provider=t,i.token=r,i.extraData=n,i.useJwt=o,i}return u(t,e),t.prototype.getBody=function(){return{provider:0,token:this.token,extraData:"",useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),oe=function(e){function t(){var t=e.call(this)||this;return t.accessToken=new w,t.refreshToken=new w,t.uid="",t}return u(t,e),t.prototype.constructResponse=function(e){this.uid=e.data.uid,this.accessToken.setToken(e.data.accessToken.token),this.accessToken.setValidPeriod(e.data.accessToken.validPeriod),this.refreshToken.setToken(e.data.refreshToken.token),this.refreshToken.setValidPeriod(e.data.refreshToken.validPeriod),this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t.prototype.getUid=function(){return this.uid},t.prototype.getAccessToken=function(){return this.accessToken},t.prototype.getRefreshToken=function(){return this.refreshToken},t}(o),ie=function(e){function t(t,r,n){var o=e.call(this)||this;return o.URL=m.SERVER_URL+"/reset-password",o.email=t,o.newPassword=r,o.verifyCode=n,o}return u(t,e),t.prototype.getBody=function(){return{account:this.email,password:this.newPassword,verifyCode:this.verifyCode,provider:12}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(y),se=function(e){function t(t,r,n,o){var i=e.call(this)||this;return i.URL=m.SERVER_URL+"/reset-password",i.countryCode=t,i.phoneNumber=r,i.newPassword=n,i.verifyCode=o,i}return u(t,e),t.prototype.getBody=function(){var e=this.phoneNumber;return this.countryCode&&(e=this.countryCode.startsWith("+")?this.countryCode+"-"+this.phoneNumber:"+"+this.countryCode+"-"+this.phoneNumber),{account:e,password:this.newPassword,verifyCode:this.verifyCode,provider:11}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(y),ae=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),ue=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),ce=function(e){function t(t,r){var n=e.call(this)||this;return n.URL=m.SERVER_URL+"/user-signout",n.bodyAccessToken=t,n.refreshToken=r,n}return u(t,e),t.prototype.getBody=function(){return{refreshToken:this.refreshToken,accessToken:this.bodyAccessToken}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(y),de=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return u(t,e),t}(o),he=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-delete",t}return u(t,e),t.prototype.getBody=function(){return""},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(y),pe=function(e){function t(t,r,n,o,i){var s=e.call(this)||this;return s.URL=m.SERVER_URL+"/user-register",s.provider=-1,s.useJwt=0,s.email=t,s.phone=r,s.password=n,s.verifyCode=o,s.useJwt=i,s}return u(t,e),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setPhone=function(e){this.phone=e},t.prototype.setEmail=function(e){this.email=e},t.prototype.setVerifyCode=function(e){this.verifyCode=e},t.prototype.setPassword=function(e){this.password=e},t.prototype.getBody=function(){return{phone:this.phone,provider:this.provider,email:this.email,password:this.password,verifyCode:this.verifyCode,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),fe=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/user-signin",t.provider=-1,t.token="",t.extraData="",t.autoCreateUser=-1,t.useJwt=0,t}return u(t,e),t.prototype.setUseJwt=function(e){this.useJwt=e},t.prototype.getExtraData=function(){return this.extraData},t.prototype.setExtraData=function(e){this.extraData=e},t.prototype.setAutoCreateUser=function(e){this.autoCreateUser=e},t.prototype.setProvider=function(e){this.provider=e},t.prototype.setToken=function(e){this.token=e},t.prototype.getBody=function(){return{provider:this.provider,token:this.token,extraData:this.extraData,autoCreateUser:this.autoCreateUser,useJwt:this.useJwt}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),le=function(){function e(e,t){this.shortestInterval=e,this.validityPeriod=t}return e.prototype.getShortestInterval=function(){return this.shortestInterval},e.prototype.getValidityPeriod=function(){return this.validityPeriod},e}(),ge=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.URL=m.SERVER_URL+"/verify-code",t.phone="",t.email="",t.action=-1,t.lang="",t.sendInterval=-1,t}return u(t,e),t.prototype.setPhone=function(e){this.phone=e},t.prototype.setEmail=function(e){this.email=e},t.prototype.setAction=function(e){this.action=e},t.prototype.setLang=function(e){this.lang=e},t.prototype.setSendInterval=function(e){this.sendInterval=e},t.prototype.getBody=function(){return{phone:this.phone,email:this.email,lang:this.lang,action:this.action,sendInterval:this.sendInterval}},t.prototype.getHeader=function(){return this.getAuthHeader()},t.prototype.getUrl=function(){return this.getAgcgwUrl()+this.URL+"?productId="+this.getHeaderProductId()},t}(m),ve=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.shortestInterval="",t.validityPeriod="",t}return u(t,e),t.prototype.constructResponse=function(e){this.shortestInterval=e.data.shortestInterval,this.validityPeriod=e.data.validityPeriod,this.ret.setMsg(e.data.ret.msg),this.ret.setCode(e.data.ret.code)},t.prototype.getShortestInterval=function(){return this.shortestInterval},t.prototype.setShortestInterval=function(e){this.shortestInterval=e},t.prototype.getValidityPeriod=function(){return this.validityPeriod},t.prototype.setValidityPeriod=function(e){this.validityPeriod=e},t}(o),ye=function(){function t(t){this.instance=t||e.instance(),this.authBackend=new Z(this.instance)}return t.prototype.requestEmailVerifyCode=function(e,t){var r=this.buildRequest(e,"",t);return r.setAGCInstance(this.instance),this.requestVerifyCode(r)},t.prototype.requestPhoneVerifyCode=function(e,t,r){var n=M.combinatePhone(e,t),o=this.buildRequest("",n,r);return o.setAGCInstance(this.instance),this.requestVerifyCode(o)},t.prototype.requestVerifyCode=function(e){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){switch(r.label){case 0:return t=new ve,[4,this.authBackend.post(e,t).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_GET_VERIFY_CODE,e))}))];case 1:return r.sent(),0!=t.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(t.getRet()))]:[2,Promise.resolve(new le(t.getShortestInterval(),t.getValidityPeriod()))]}}))}))},t.prototype.buildRequest=function(e,t,r){if(!r)throw new g(v.FAIL_TO_GET_VERIFY_CODE,{message:"invalid verifyCodeSettings"});var n=new ge;return n.setEmail(e),n.setPhone(t),n.setAction(r.getAction()),n.setLang(r.getLang()),n.setSendInterval(r.getSendInterval()),n},t}(),me=function(){function e(e,t,r){this.action=e,this.lang=t,this.sendInterval=r}return e.prototype.getAction=function(){return this.action},e.prototype.getLang=function(){return this.lang},e.prototype.getSendInterval=function(){return this.sendInterval},e.prototype.setAction=function(e){this.action=e},e.prototype.setLang=function(e){this.lang=e},e.prototype.setSendInterval=function(e){this.sendInterval=e},e}(),Pe=s.createLogger("auth"),we=function(){function t(t){this.persistence=2,this.cryptImpl=void 0,this.identifier=t,this.authBackend=new Z(e.instance(this.identifier)),this.storedUserManager=new re(e.instance(this.identifier)),this.verifyCodeRequestService=new ye(e.instance(this.identifier))}return t.prototype.createEmailUser=function(t){return c(this,void 0,void 0,(function(){var r,o=this;return d(this,(function(i){return r=this,[2,this.getCurrentUser().then((function(n){return c(o,void 0,void 0,(function(){var o,i,s;return d(this,(function(a){switch(a.label){case 0:return n&&!n.isAnonymous()?[2,Promise.reject(new g(v.ALREADY_SIGN_IN_USER))]:t?(t.verifyEmailUser(!1),(o=new pe(t.email,"",t.password,t.verifyCode,1)).setProvider(12),o.setAGCInstance(e.instance(r.identifier)),i=new b,[4,r.authBackend.post(o,i)]):[2,Promise.reject(new g(v.INVALID_EMAIL))];case 1:return a.sent(),0!=i.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(i.getRet()))]:((s=new K(e.instance(r.identifier))).buildUser(i),[4,r.storedUserManager.updateStoredUser(s,0)]);case 2:return a.sent(),[2,Promise.resolve(new C(s))]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_CREAT_EMAIL_USER,e))}))]}))}))},t.prototype.createPhoneUser=function(t){return c(this,void 0,void 0,(function(){var r,o=this;return d(this,(function(i){return r=this,[2,this.getCurrentUser().then((function(n){return c(o,void 0,void 0,(function(){var o,i,s;return d(this,(function(a){switch(a.label){case 0:return n&&!n.isAnonymous()?[2,Promise.reject(new g(v.ALREADY_SIGN_IN_USER))]:t?(t.verifyPhoneUser(!1),(o=new pe("",t.getPhone(),t.password,t.verifyCode,1)).setProvider(11),o.setAGCInstance(e.instance(r.identifier)),i=new b,[4,r.authBackend.post(o,i)]):[2,Promise.reject(new g(v.INVALID_PHONE))];case 1:return a.sent(),0!=i.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(i.getRet()))]:((s=new K(e.instance(r.identifier))).buildUser(i),[4,r.storedUserManager.updateStoredUser(s,0)]);case 2:return a.sent(),[2,Promise.resolve(new C(s))]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_CREAT_PHONE_USER,e))}))]}))}))},t.prototype.signIn=function(e){return c(this,void 0,void 0,(function(){var t,r=this;return d(this,(function(o){return e?(t=this,[2,this.getCurrentUser().then((function(n){return c(r,void 0,void 0,(function(){var r;return d(this,(function(o){switch(o.label){case 0:return n&&!n.isAnonymous()?[2,Promise.reject(new g(v.ALREADY_SIGN_IN_USER))]:[4,t.getUserWithCredential(e)];case 1:return r=o.sent(),[2,Promise.resolve(r)]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.SIGN_IN_FAILED,e))}))]):[2,Promise.reject(new g(v.SIGN_IN_FAILED,{message:"credential invalid"}))]}))}))},t.prototype.getUserWithCredential=function(t){return c(this,void 0,void 0,(function(){var r,n,o,i;return d(this,(function(s){switch(s.label){case 0:if(r=new fe,t instanceof R)t.prepareUserAuthRequest(r),r.setAutoCreateUser(t.autoCreateUser?1:0);else{if(!(t instanceof A))return[2,Promise.reject(new g(v.SIGN_IN_FAILED,{message:"credential type error"}))];t.prepareUserAuthRequest(r)}return t instanceof O&&((n=JSON.parse(r.getExtraData())).appId=e.instance(this.identifier).config().client.app_id,n.cpId=e.instance(this.identifier).config().client.cp_id,r.setExtraData(JSON.stringify(n))),r.setUseJwt(1),r.setAGCInstance(e.instance(this.identifier)),o=new b,[4,this.authBackend.post(r,o)];case 1:return s.sent(),0!=o.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(o.getRet()))]:((i=new K(e.instance(this.identifier))).buildUser(o),[4,this.storedUserManager.updateStoredUser(i,0)]);case 2:return s.sent(),[2,Promise.resolve(new C(i))]}}))}))},t.prototype.deleteUser=function(){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){return t=this,[2,this.getCurrentUser().then((function(r){return c(this,void 0,void 0,(function(){var n,o,i;return d(this,(function(s){switch(s.label){case 0:return null==r?[3,3]:(n=r,o=new he,i=new de,o.setAccessToken(n.getAccessToken()),o.setAGCInstance(e.instance(t.identifier)),[4,t.authBackend.post(o,i)]);case 1:return s.sent(),0!=i.getRet().getCode()?(Pe.error("deleteUser fail."),[2,Promise.reject(g.constructExcpFromRet(i.getRet()))]):[4,t.storedUserManager.updateStoredUser(null,3)];case 2:return s.sent(),Pe.log("deleteUser success."),[2,Promise.resolve()];case 3:return Pe.error("deleteUser fail, no user signed in."),[2,Promise.reject(new g(v.DELETE_USER_FAILED,{message:"no user signed in"}))]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.DELETE_USER_FAILED,e))}))]}))}))},t.prototype.signOut=function(){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){switch(r.label){case 0:return t=this,[4,this.getCurrentUser().then((function(r){return c(this,void 0,void 0,(function(){var n,o,i;return d(this,(function(s){switch(s.label){case 0:return null==r?[3,2]:((o=new ce((n=r).getAccessToken(),n.getRefreshToken())).setAGCInstance(e.instance(t.identifier)),i=new de,t.authBackend.post(o,i).catch((function(e){Pe.warn("signOut request fail.")})),[4,t.storedUserManager.updateStoredUser(null,3)]);case 1:return s.sent(),[2,Promise.resolve()];case 2:return[2]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.SIGN_OUT_FAILED,e))}))];case 1:return r.sent(),[2]}}))}))},t.prototype.getCurrentUser=function(){return c(this,void 0,void 0,(function(){var t;return d(this,(function(r){return t=this,[2,this.storedUserManager.getStoredUser().then((function(r){if(r){var n=new K(e.instance(t.identifier));return n.getUser().constructUser(r),Promise.resolve(n)}return Promise.resolve(null)})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.GET_CURRENT_USER_FAILED,e))}))]}))}))},t.prototype.signInAnonymously=function(){var e=this;return this.getCurrentUser().then((function(t){if(null!=t){if(t.isAnonymous()){var r=new C(t);return Promise.resolve(r)}return Promise.reject(new g(v.ALREADY_SIGN_IN_USER))}return e.getUserWithAnonymously()})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.SIGN_IN_ANONYMOUS_FAILED,e))}))},t.prototype.getUserWithAnonymously=function(){return c(this,void 0,void 0,(function(){var t,r,n,o,i,s;return d(this,(function(a){switch(a.label){case 0:return null==(t=e.instance(this.identifier).getService("ClientInfoService"))?[2,Promise.reject(new g(v.FAIL_TO_GET_UTIL_SERVICE))]:(r="",[4,t.getAaid().then((function(e){r=e}))]);case 1:return a.sent(),r?((n=new ne(0,r,"",1)).setAGCInstance(e.instance(this.identifier)),o=new oe,[4,this.authBackend.post(n,o)]):[2,Promise.reject(new g(v.SIGN_IN_ANONYMOUS_FAILED,{message:"The aaid is null"}))];case 2:return a.sent(),0!=o.getRet().getCode()?[2,Promise.reject(g.constructExcpFromRet(o.getRet()))]:(i=new K(e.instance(this.identifier)),(s=new ee(this.identifier)).uid=o.getUid(),s.providerId=(0).toString(),s.tokenService.constructeSecureTokenService(o.getAccessToken(),o.getRefreshToken()),s.anonymous=!0,i.getUser().constructUser(s),[4,this.storedUserManager.updateStoredUser(i,0)]);case 3:return a.sent(),[2,Promise.resolve(new C(i))]}}))}))},t.prototype.requestEmailVerifyCode=function(e,t,r,n){return e?this.verifyCodeRequestService.requestEmailVerifyCode(e,new me(t,r,n)):Promise.reject(new g(v.INVALID_EMAIL))},t.prototype.requestPhoneVerifyCode=function(e,t,r,n,o){return t?this.verifyCodeRequestService.requestPhoneVerifyCode(e,t,new me(r,n,o)):Promise.reject(new g(v.INVALID_PHONE))},t.prototype.setUserInfoPersistence=function(e){this.persistence=e},t.prototype.getUserInfoPersistence=function(){return this.persistence},t.prototype.setCryptImp=function(e){return e?e.decrypt&&e.decrypt instanceof Function&&e.encrypt&&e.encrypt instanceof Function?(this.cryptImpl=e,!0):(Pe.error("the crypt must have decrypt and encrypt method."),!1):(Pe.error("the crypt is not available."),!1)},t.prototype.getCryptImp=function(){return this.cryptImpl},t.prototype.addTokenListener=function(e){te.getInstance(this.identifier).addTokenListener(e)},t.prototype.removeTokenListener=function(e){te.getInstance(this.identifier).removeTokenListener(e)},t.prototype.resetPasswordByEmail=function(t,r,o){return c(this,void 0,void 0,(function(){var i,s,a,u=this;return d(this,(function(h){return t?r?o?((i=new ie(t,r,o)).setAGCInstance(e.instance(this.identifier)),s=new ae,a=this,[2,this.authBackend.post(i,s).then((function(e){return c(u,void 0,void 0,(function(){var e,t;return d(this,(function(r){switch(r.label){case 0:return 0!=s.getRet().getCode()?(Pe.error("failed to reset the password of the email"),[2,Promise.reject(g.constructExcpFromRet(s.getRet()))]):[4,a.getCurrentUser()];case 1:return null==(e=r.sent())?[3,3]:((t=e).getUser().passwordSetted=1,[4,a.storedUserManager.updateStoredUser(t)]);case 2:r.sent(),r.label=3;case 3:return Pe.log("success to reset the password of the email"),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_EMAIL,e))}))]):[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"verifyCode can not be null or empty"}))]:[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"newPassword can not be null or empty"}))]:[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_EMAIL,{message:"email can not be null or empty"}))]}))}))},t.prototype.resetPasswordByPhone=function(t,r,o,i){return c(this,void 0,void 0,(function(){var s,a,u,h=this;return d(this,(function(p){return t?r?o?i?((s=new se(t,r,o,i)).setAGCInstance(e.instance(this.identifier)),a=new ue,u=this,[2,this.authBackend.post(s,a).then((function(){return c(h,void 0,void 0,(function(){var e,t;return d(this,(function(r){switch(r.label){case 0:return 0!=a.getRet().getCode()?(Pe.error("failed to reset the password of the phone"),[2,Promise.reject(g.constructExcpFromRet(a.getRet()))]):[4,u.getCurrentUser()];case 1:return null==(e=r.sent())?[3,3]:((t=e).getUser().passwordSetted=1,[4,u.storedUserManager.updateStoredUser(t)]);case 2:r.sent(),r.label=3;case 3:return Pe.log("success to reset the password of the phone"),[2,Promise.resolve()]}}))}))})).catch((function(e){return e instanceof n?Promise.reject(e):Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_PHONE,e))}))]):[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_PHONE,{message:"verifyCode can not be null or empty"}))]:[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_PHONE,{message:"newPassword can not be null or empty"}))]:[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_PHONE,{message:"phoneNumber can not be null or empty"}))]:[2,Promise.reject(new g(v.FAIL_TO_RESET_PASSWORD_PHONE,{message:"countryCode can not be null or empty"}))]}))}))},t}(),Ie=function(){function e(e,t,r,n){this.countryCode="",this.phoneNumber="",this.password="",this.verifyCode="",this.countryCode=e,this.phoneNumber=t,this.password=r,this.verifyCode=n}return e.prototype.getPhone=function(){return M.combinatePhone(this.countryCode,this.phoneNumber)},e.prototype.verifyPhoneUser=function(e){if(!this.phoneNumber)throw new g(v.INVALID_PHONE);if(""==this.password&&e)throw new g(v.PASSWORD_IS_EMPTY);if(""==this.verifyCode)throw new g(v.PHONE_VERIFICATION_IS_EMPTY)},e}(),Te=function(){function e(e,t,r){this.email="",this.password="",this.verifyCode="",this.email=e,this.password=t,this.verifyCode=r}return e.prototype.verifyEmailUser=function(e){if(!this.email)throw new g(v.INVALID_EMAIL);if(!this.password&&e)throw new g(v.PASSWORD_IS_EMPTY);if(!this.verifyCode)throw new g(v.EMAIL_VERIFICATION_IS_EMPTY)},e}(),Ee=function(e){function t(t,r,n){var o=e.call(this)||this;return o.email=t,o.password=r,o.verifyCode=n,o}return u(t,e),t.prototype.getProvider=function(){return 12},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData()),e.setUseJwt(1)},t.prototype.generateExtraData=function(){return JSON.stringify({password:this.password,verifyCode:this.verifyCode})},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(12),e.setToken(this.email),e.setExtraData(this.generateExtraData())},t}(A),Ue=function(){function e(){}return e.credentialWithPassword=function(e,t){return new Ee(e,t,"")},e.credentialWithVerifyCode=function(e,t,r){return new Ee(e,t,r)},e.requestVerifyCode=function(e,t,r,n){return(new ye).requestEmailVerifyCode(e,new me(t,r,n))},e}(),_e=function(e){function t(t,r,n,o){var i=e.call(this)||this;return i.countryCode=t,i.phoneNumber=r,i.password=n,i.verifyCode=o,i}return u(t,e),t.prototype.getProvider=function(){return 11},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData()),e.setUseJwt(1)},t.prototype.generateExtraData=function(){return JSON.stringify({password:this.password,verifyCode:this.verifyCode})},t.prototype.getPhone=function(){return M.combinatePhone(this.countryCode,this.phoneNumber)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(11),e.setToken(this.getPhone()),e.setExtraData(this.generateExtraData())},t}(A),ke=function(){function e(){}return e.credentialWithPassword=function(e,t,r){return new _e(e,t,r,"")},e.credentialWithVerifyCode=function(e,t,r,n){return new _e(e,t,r,n)},e.requestVerifyCode=function(e,t,r,n,o){return(new ye).requestPhoneVerifyCode(e,t,new me(r,n,o))},e}(),Re=function(e){function t(t,r,n){var o=e.call(this)||this;return o.token=t,o.openId=r,o.autoCreateUser=n,o}return u(t,e),t.prototype.getProvider=function(){return 4},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(4),e.setToken(this.token),e.setExtraData(this.openId)},t}(R),Ae=function(){function e(){}return e.credentialWithToken=function(e,t,r){return void 0===r&&(r=!0),new Re(e,t,r)},e}(),Se=function(e){function t(t,r){var n=e.call(this)||this;return n.token=t,n.autoCreateUser=r,n}return u(t,e),t.prototype.getProvider=function(){return 10},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(10),e.setToken(this.token),e.setUseJwt(1)},t}(R),Ce=function(){function e(){}return e.credentialWithToken=function(e,t){return void 0===t&&(t=!0),new Se(e,t)},e}(),Le=function(e){function t(t,r,n){void 0===n&&(n=!0);var o=e.call(this)||this;return o.token=t,o.openId=r,o.autoCreateUser=n,o}return u(t,e),t.prototype.getProvider=function(){return 6},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(6),e.setToken(this.token),e.setExtraData(this.openId)},t}(R),Ne=function(){function e(){}return e.credentialWithToken=function(e,t,r){return void 0===r&&(r=!0),new Le(e,t,r)},e}(),Oe=function(){function t(t){this.instance=e.instance(),this.instance=t||e.instance(),this.storedUserManager=new re(this.instance)}return t.prototype.getToken=function(e){return c(this,void 0,void 0,(function(){var t,r,n,o;return d(this,(function(i){switch(i.label){case 0:return this.instance.getCustomAuthProvider()?[4,this.instance.getCustomAuthProvider().getToken(e)]:[3,2];case 1:return(t=i.sent())&&t.tokenString&&t.expiration?isNaN(Number(t.expiration))||Number(t.expiration)<=0?(Pe.error("the customAuthProvider getToken must return valid expiration."),[2,Promise.reject(new g(v.ILLEGAL_CUSTOM_AUTH_PROVIDER,{message:"the customAuthProvider getToken must return valid expiration"}))]):(r=new(function(){function e(){}return e.prototype.getExpirePeriod=function(){return Number(t.expiration)},e.prototype.getToken=function(){return t.tokenString},e}()),[2,Promise.resolve(r)]):(Pe.error("the customAuthProvider getToken method must contain return value: tokenString, expiration."),[2,Promise.reject(new g(v.ILLEGAL_CUSTOM_AUTH_PROVIDER,{message:"the customAuthProvider getToken method must contain return value: tokenString, expiration"}))]);case 2:return[4,this.storedUserManager.getStoredUser()];case 3:return(n=i.sent())?((o=new K(this.instance)).getUser().constructUser(n),[2,o.getToken(e)]):[2,Promise.resolve(null)]}}))}))},t}(),De=function(e){function t(t,r){var n=e.call(this)||this;return n.token=t,n.autoCreateUser=r,n}return u(t,e),t.prototype.getProvider=function(){return 1},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(1),e.setToken(this.token)},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(1),e.setToken(this.token),e.setUseJwt(1)},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(1),e.setToken(this.token)},t}(R),Ve=function(){function e(){}return e.credentialWithToken=function(e,t){return void 0===t&&(t=!0),new De(e,t)},e}(),be=function(e){function t(t,r){void 0===r&&(r=!0);var n=e.call(this)||this;return n.authCode=t,n.autoCreateUser=r,n}return u(t,e),t.prototype.getProvider=function(){return 18},t.prototype.prepareUserAuthRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserLinkRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.prepareUserReauthRequest=function(e){e.setProvider(18),e.setToken(t.TOKEN),e.setExtraData(this.generateExtraData())},t.prototype.generateExtraData=function(){return JSON.stringify({authCode:this.authCode})},t.TOKEN="alipay",t}(R),xe=function(){function e(){}return e.credentialWithToken=function(e,t){return void 0===t&&(t=!0),new be(e,t)},e}(),je=function(){function e(){}return e.credentialWithPlayerSign=function(e,t){void 0===t&&(t=!0);var r={};return r.ts=e.signTs,r.playerId=e.playerId,r.playerLevel=e.playerLevel,r.displayName=e.displayName,r.imageUrl=e.imageUrl,new O(e.playerSign,JSON.stringify(r),t)},e}(),Fe=new r((function(e){return new we(e[0])}));function Ge(e){return new Oe(e)}!function(e){e[e.ACTION_REGISTER_LOGIN=1001]="ACTION_REGISTER_LOGIN",e[e.ACTION_RESET_PASSWORD=1002]="ACTION_RESET_PASSWORD"}(Y||(Y={})),function(e){e[e.Anonymous=0]="Anonymous",e[e.HMS_Provider=1]="HMS_Provider",e[e.Facebook_Provider=2]="Facebook_Provider",e[e.Twitter_Provider=3]="Twitter_Provider",e[e.WeiXin_Provider=4]="WeiXin_Provider",e[e.HWGame_Provider=5]="HWGame_Provider",e[e.QQ_Provider=6]="QQ_Provider",e[e.WeiBo_Provider=7]="WeiBo_Provider",e[e.Google_Provider=8]="Google_Provider",e[e.GoogleGame_Provider=9]="GoogleGame_Provider",e[e.SelfBuild_Provider=10]="SelfBuild_Provider",e[e.Phone_Provider=11]="Phone_Provider",e[e.Email_Provider=12]="Email_Provider",e[e.Alipay_Provider=18]="Alipay_Provider"}(X||(X={})),Q={PhoneUser:Ie,EmailUser:Te,EmailAuthProvider:Ue,PhoneAuthProvider:ke,WeixinAuthProvider:Ae,SelfBuildAuthProvider:Ce,QQAuthProvider:Ne,HwIdAuthProvider:Ve,AlipayAuthProvider:xe,HwGameAuthProvider:je,Action:Y,AGConnectAuthCredentialProvider:X},(z=e).registerApiProvider("auth",(function(e){return Fe.get(e)}),Q),z.registerInternalService({name:"AuthProviderService",serviceFactory:Ge});export{g as AGCAuthException,Fe as creator};
