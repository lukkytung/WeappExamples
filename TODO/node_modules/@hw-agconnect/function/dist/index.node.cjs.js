"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@hw-agconnect/api"),t=require("@hw-agconnect/core"),r=require("@hw-agconnect/instance");require("@hw-agconnect/network"),require("@hw-agconnect/baseservice");var n=require("bignumber.js"),o=require("spark-md5"),i=require("@hw-agconnect/log");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var a=s(e),u=s(n),h=c(o),l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function d(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((n=n.apply(e,t||[])).next())}))}function p(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.responseBody=void 0,t}return f(t,e),t.prototype.constructResponse=function(e){this.responseBody=e},t.prototype.getValue=function(){return this.responseBody?this.responseBody:null},t}(r.BaseResponse),v=function(){function e(){}return e.FAIL_TO_GET_CREDENTIAL_SERVICE={code:11e3,message:"get agcCredential service failed"},e.FAIL_TO_GET_NETWORK_SERVICE={code:11001,message:"get agcNetwork service failed"},e.FAIL_TO_CALL_CLOUD_FUNCTION={code:11002,message:"call cloud function failed"},e.FAIL_TO_GET_ACCESS_TOKEN={code:11003,message:"no user login"},e}(),T=function(e){function t(r,n){var o=e.call(this,r,n,"function")||this;return o.__proto__=t.prototype,o}return f(t,e),t.constructExcpFromRet=function(e){return new t({code:e.getCode(),message:e.getMsg()})},t}(r.AGCError),k=function(){function e(){}return e.prototype.getAccessToken=function(e,t){return d(this,void 0,void 0,(function(){var r;return p(this,(function(n){switch(n.label){case 0:return e?[4,e.getToken(t)]:[3,2];case 1:if(r=n.sent())return[2,r.getToken()];n.label=2;case 2:return[2,Promise.resolve(null)]}}))}))},e.prototype.doRequest=function(t,r,n,o){return d(this,void 0,void 0,(function(){var i,s,c,u,h,l,f,k=this;return p(this,(function(_){switch(_.label){case 0:return i=a.default.instance().getService("AuthProviderService"),[4,this.getAccessToken(i,!1)];case 1:return(s=_.sent())&&t.setAccessToken(s),c=t.getHeader(),(u=a.default.instance().getService("CredentialsService"))?(h="",[4,u.getToken().then((function(e){h=e.tokenString}))]):(I.error("get credentialProvider service failed."),[2,Promise.reject(new T(v.FAIL_TO_GET_CREDENTIAL_SERVICE))]);case 2:return _.sent(),c.Authorization="Bearer "+h,l=void 0,r&&(l={timeout:r,timeoutErrorMessage:"CloudFunction run out of time"}),f=new g,[4,this.doNetworkOption(t,c,f,l).catch((function(s){return d(k,void 0,void 0,(function(){var c;return p(this,(function(a){switch(a.label){case 0:return s.response&&s.response.status&&s.response.data&&s.response.data.ret&&s.response.data.ret.code?s.response.status!==e.TOKEN_INVALID?[3,6]:(c=s.response.data.ret.code)==e.CLIENT_TOKEN_EXPIRED&&n?[4,u.removeToken()]:[3,3]:[3,6];case 1:return a.sent(),[4,u.getToken(!0)];case 2:return a.sent(),[2,this.doRequest(t,r,!1,o)];case 3:return c==e.ACCESS_TOKEN_EXPIRED&&o?i?[4,i.getToken(!0)]:[3,5]:[3,6];case 4:a.sent(),a.label=5;case 5:return[2,this.doRequest(t,r,n,!1)];case 6:return s.message&&-1!=s.message.indexOf("Network Error")&&!t.useBackUrl?(t.useBackUrl=!0,[2,this.doRequest(t,r,n,o)]):[2,Promise.reject(s)]}}))}))}))];case 3:return _.sent(),[2,Promise.resolve(f)]}}))}))},e.prototype.doNetworkOption=function(t,r,n,o){return d(this,void 0,void 0,(function(){var i;return p(this,(function(s){switch(s.label){case 0:return(i=a.default.instance().getService("AGCNetworkService"))?[4,i.post(t.getUrl(),t.getBody(),r,o).then((function(t){return t.status&&t.status===e.HTTP_OK?(n.ret.setCode(0),n.ret.setMsg("OK"),n.constructResponse(t.data),Promise.resolve()):Promise.reject(t)})).catch((function(e){return Promise.reject(e)}))]:(I.error("get agcNetwork service failed."),[2,Promise.reject(new T(v.FAIL_TO_GET_NETWORK_SERVICE))]);case 1:return s.sent(),[2]}}))}))},e.CLIENT_TOKEN_EXPIRED=205524993,e.ACCESS_TOKEN_EXPIRED=205524994,e.TOKEN_INVALID=401,e.HTTP_OK=200,e}(),_=function(){function e(){this.sdkServiceName="",this.sdkVersion="",this.sdkPlatform="",this.sdkPlatformVersion="",this.sdkType="JS",this.packageName="",this.appVersion="",this.headerClientId="",this.authorization="",this.headerProductId="",this.headerAppId="",this.agcgwUrl="",this.agcgwBackUrl=""}return e.prototype.init=function(){this.sdkServiceName="agconnect-function",this.sdkVersion="1.5.1";var e=a.default.instance().getService("AGCPlatformInfoService");e&&(this.sdkPlatform=e.getPlatform(),this.sdkPlatformVersion=e.getPlatformVersion(),this.packageName=e.getPackageName(),this.appVersion=e.getAppVersion()),this.authorization="",this.agcConfig=a.default.instance().config(),this.headerProductId=this.agcConfig.client.product_id,this.headerClientId=this.agcConfig.client.client_id,this.headerAppId=this.agcConfig.client.app_id,this.agcgwUrl=this.addHttpToUrl(this.agcConfig.agcgw.url),this.agcgwBackUrl=this.addHttpToUrl(this.agcConfig.agcgw.backurl)},e.prototype.addHttpToUrl=function(e){return e&&!e.startsWith("https://")?"https://"+e:e},e}(),y="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",w=function(){function e(){}return e.hash=function(t,r){var n="agc:"+t+"@"+r,o=h.hash(n);o="0x"+o;var i=new u.default(o);return e.encode(i)},e.encode=function(e){for(var t="";e.isGreaterThan(61);){var r=e.modulo(62);t=y.charAt(r.toNumber())+t,e=e.dividedToIntegerBy(62)}return t=y.charAt(e.toNumber())+t},e}(),m=function(e){function t(t,r){var n=e.call(this)||this;return n.useBackUrl=!1,n.accessToken="",n.body=r,n.httpTriggerURI=t,n}return f(t,e),t.prototype.getUrl=function(){var e=this.agcConfig.client.cp_id,r=this.agcConfig.client.product_id,n=w.hash(e,r);return this.httpTriggerURI&&this.httpTriggerURI.length>0&&"/"!=this.httpTriggerURI.charAt(0)&&(this.httpTriggerURI="/"+this.httpTriggerURI),this.useBackUrl?this.agcgwBackUrl+t.SERVER_URL+"/"+n+this.httpTriggerURI:this.agcgwUrl+t.SERVER_URL+"/"+n+this.httpTriggerURI},t.prototype.getHeader=function(){return{sdkVersion:this.sdkVersion,sdkPlatform:this.sdkPlatform,sdkServiceName:this.sdkServiceName,sdkPlatformVersion:this.sdkPlatformVersion,sdkType:this.sdkType,packageName:this.packageName,appVersion:this.appVersion,appId:this.headerAppId,clientId:this.headerClientId,productId:this.headerProductId,Authorization:this.authorization,"Content-Type":"application/json;charset=UTF-8",accessToken:this.accessToken,access_token:this.accessToken}},t.prototype.getBody=function(){return this.body},t.prototype.setAccessToken=function(e){this.accessToken=e},t.SERVER_URL="/agc/apigw/wisefunction/functions",t}(_),E=function(){function e(e){this.httpTriggerURI="",this.timeout=void 0,this.functionBackend=new k,this.httpTriggerURI=e}return e.prototype.call=function(e){return d(this,void 0,void 0,(function(){return p(this,(function(t){return[2,this.callFunction(e)]}))}))},e.prototype.callFunction=function(e){return d(this,void 0,void 0,(function(){var t,n;return p(this,(function(o){switch(o.label){case 0:return(t=new m(this.httpTriggerURI,e)).init(),[4,this.functionBackend.doRequest(t,this.timeout,!0,!0).catch((function(e){return e instanceof r.AGCError?Promise.reject(e):Promise.reject(new T(v.FAIL_TO_CALL_CLOUD_FUNCTION,e))}))];case 1:return n=o.sent(),[2,Promise.resolve(n)]}}))}))},e.prototype.clone=function(t){var r=new e(this.httpTriggerURI);return r.timeout=t,r},e}(),I=i.Logger.createLogger("function"),C=function(){function e(){}return e.prototype.wrap=function(e){return new E(e)},e}(),R=new t.Singleton((function(){return new C}));a.default.registerApiProvider("function",(function(){return R.get()})),exports.AGCFunctionException=T;
