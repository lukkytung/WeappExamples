import e from"@hw-agconnect/api";import{Logger as t}from"@hw-agconnect/log";import{AGCError as r,AGCErrorCode as n}from"@hw-agconnect/instance";import{DEFAULT_CATEGORY as o}from"@hw-agconnect/core";var s=function(){function e(){this.storage={}}return e.getInstance=function(t,r){return e.memoryInsMap.has(t)&&e.memoryInsMap.get(t)||e.memoryInsMap.set(t,new e),e.memoryInsMap.get(t)},e.prototype.get=function(e){return Promise.resolve(this.storage[e])},e.prototype.remove=function(e){return delete this.storage[e],Promise.resolve()},e.prototype.set=function(e,t){return this.storage[e]=t,Promise.resolve()},e.memoryInsMap=new Map,e}(),i=function(){function e(e){this.encryptImpl=void 0,this.encryptImpl=e}return e.prototype.setEncryptImp=function(e){this.encryptImpl=e},e.prototype.decrypt=function(e){return null!=this.encryptImpl&&null!=this.encryptImpl&&null!=e&&null!=e?this.encryptImpl.decrypt(e):e},e.prototype.encrypt=function(e){return null!=this.encryptImpl&&null!=this.encryptImpl&&null!=e&&null!=e?this.encryptImpl.encrypt(e):e},e}(),c=function(){function e(){this.DB_NAME="agcLocalStorageDb",this.OBJECT_STORE_NAME="agc",this.KEY_PATH="agcStorage",this.VERSION=1,this.agcCryptImpl=new i}return e.getInstance=function(o,s){if(!window.indexedDB)throw t.createLogger("AGCStorageService").error("Your environment doesn't support a stable version of IndexedDB."),new r(n.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of IndexedDB."});e.indexedDBInsMap.has(o)&&e.indexedDBInsMap.get(o)||e.indexedDBInsMap.set(o,new e);var i=e.indexedDBInsMap.get(o);return i.agcCryptImpl.setEncryptImp(s),i},e.prototype.initIndexedDb=function(e){var t=this;return window.indexedDB?new Promise((function(r,n){var o=window.indexedDB.open(t.DB_NAME,t.VERSION),s=t;o.onupgradeneeded=function(e){var t=e.target.result;try{t.objectStoreNames.contains(s.OBJECT_STORE_NAME)||t.createObjectStore(s.OBJECT_STORE_NAME,{keyPath:s.KEY_PATH})}catch(e){n(e)}},o.onsuccess=function(t){try{r(t.target.result.transaction([s.OBJECT_STORE_NAME],e).objectStore(s.OBJECT_STORE_NAME))}catch(e){n(e)}},o.onerror=function(e){n(e.target.error)}})):Promise.reject(new r(n.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of IndexedDB."},"storage"))},e.prototype.get=function(e){if(!e)return Promise.reject(new Error("get key is null"));var t=this;return this.initIndexedDb("readonly").then((function(r){return new Promise((function(n,o){try{var s=r.get(e);s.onsuccess=function(){var e=s.result;n(null!=e&&"value"in e?t.agcCryptImpl.decrypt(e.value):e)},s.onerror=function(e){o(e.target.error)}}catch(e){o(e)}}))})).catch((function(e){return Promise.reject(e)}))},e.prototype.set=function(e,t){if(!e||!t)return Promise.reject(new Error("set key or value is null"));var r={},n={};r[this.KEY_PATH]=e,n.value=this.agcCryptImpl.encrypt(t);var o=Object.assign(n,r);return this.initIndexedDb("readwrite").then((function(t){try{var r=t.get(e);return r.onsuccess=function(){var e=r.result,n=null!=e&&"value"in e?t.put(o):t.add(o);n.onsuccess=function(){return Promise.resolve()},n.onerror=function(e){return Promise.reject(e.target.error)}},r.onerror=function(e){return Promise.reject(e.target.error)},Promise.resolve()}catch(e){return Promise.reject(e)}})).catch((function(e){return Promise.reject(e)}))},e.prototype.remove=function(e){return e?this.initIndexedDb("readwrite").then((function(t){try{var r=t.delete(e);return r.onsuccess=function(){return Promise.resolve()},r.onerror=function(e){return Promise.reject(e.target.error)},Promise.resolve()}catch(e){return Promise.reject(e)}})).catch((function(e){return Promise.reject(e)})):Promise.reject(new Error("remove key is null"))},e.indexedDBInsMap=new Map,e}(),a=function(){function e(){this.agcCryptImpl=new i}return e.getInstance=function(o,s){if(!e.isSessionStorageAvailable())throw t.createLogger("AGCStorageService").error("Your environment doesn't support a stable version of sessionStorage."),new r(n.FAIL_TO_GET_STORAGE_SERVICE,{message:"Your environment doesn't support a stable version of sessionStorage."});!e.sessionMap.has(o)&&e.sessionMap.get(o)||e.sessionMap.set(o,new e);var i=e.sessionMap.get(o);return i.agcCryptImpl.setEncryptImp(s),i},e.isSessionStorageAvailable=function(){try{return sessionStorage.setItem("agctestKey","testValue"),sessionStorage.removeItem("agctestKey"),!0}catch(e){return!1}},e.prototype.get=function(e){if(!e)return Promise.reject(new Error("key is null"));try{var t=sessionStorage.getItem(e);return Promise.resolve(""===t?null:this.agcCryptImpl.decrypt(t))}catch(e){return Promise.reject(e)}},e.prototype.set=function(e,t){if(!e||!t)return Promise.reject(new Error("key or value is null"));try{return sessionStorage.setItem(e,this.agcCryptImpl.encrypt(t)),Promise.resolve()}catch(e){return Promise.reject(e)}},e.prototype.remove=function(e){if(!e)return Promise.reject(new Error("key is null"));try{return sessionStorage.removeItem(e),Promise.resolve()}catch(e){return Promise.reject(e)}},e.sessionMap=new Map,e}(),u=function(){function e(e){this.name=o,e&&(this.name=e)}return e.prototype.getStorageInstance=function(e,t){var r;switch(e){case 2:r=s.getInstance(this.name,t);break;case 0:r=c.getInstance(this.name,t);break;case 1:r=a.getInstance(this.name,t);break;default:r=s.getInstance(this.name,t)}return r},e.prototype.createPersistentStorage=function(){return c.getInstance(this.name)},e.prototype.createTemporaryStorage=function(){return a.getInstance(this.name)},e.prototype.createMemoryStorage=function(){return s.getInstance(this.name)},e}();e.registerInternalService({name:"AGCStorageService",serviceFactory:function(e){return new u(e.name())}});
